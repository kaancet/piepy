
# PIEPY : **P**sychophysical and **I**maging **E**xperiments **Py**peline #

by Sakir Kaan Cetindag

 Code to parse, analyse and visualize psychophysical and imaging data.

## Getting set up ##

Install [git](https://git-scm.com/downloads/) and [Anaconda](https://docs.conda.io/en/latest/miniconda.html).

### Clone repository ###

Open Git Bash in the repository you want to store the code in and **right-click -> 'Git Bash here'**

*For Windows: If the 'conda' command is not found in Git Bash, that means that conda has not been added to the PATH, you can do it by right-clicking 'this PC' in 'this PC' (folder) panel, 'Advanced system settings', 'Environment Variables...', in 'User variables' select 'Path' and click 'Edit...', click 'New' and add  'C:\ProgramData\Miniconda3\Scripts' (this is the default directory for the conda.exe, select another if you choose another location during the installation).
Then you can restart Git Bash and retry.*

Clone the repository on your computer (bitbucket page, click clone and copy/paste string in Git Bash)

### 3. Environment creation ###

Open Git Bash in your piepy folder.

In Git Bash enter:

> ```conda create -n piepy python=3.10```

Then activate the newly created environment using:

> ```conda activate piepy```

### 4. Module installation ###

Open Git Bash or Terminal in your BoninBehavior directory, in Git Bash enter:

> ```pip install -e .```

This will install the module with all the necessary dependencies and you can use various CLI commands to analyse sessions etc.(WIP)

## How do I use piepy? ##

> **IMPORTANT : A `config.json` file is used to point piepy to the correct data and other directories. You need to change the paths variable according to your directory structure for piepy to work!**

piepy assumes some BLA for data locations for data in the bkrunch server, more specifically:

- Stimpy .stimlog and .riglog is in :  **<path_to_dir>/presentation/_your_experiment_name_**
- Analysed data is saved(and loaded from) : **<path_to_dir>/analysis/_your_experiment_name_**

Currently, the code only works for our in-house wheel detection task.

## Code Architecture ##

The analysis pipeline is organised in a modular way where the parsing/analysing of behavioral data is seperate from statistical analysis and plotting.

The data architecture is also set-up in a way to make it easy to pass around between analysis and plotting. For this, there is the RunData class which holds the data in a polars DataFrame, which can be plugged into dedicated statitical analysis/plotting classes.

The behavioral data is divided into four main :

### 1. Trial ###

Main parsing of the experiment data happens in the Trial class. piepy uses both .stimlog and .riglog generated by [StimPy](https://github.com/vision-to-action/stimpy) to calculate basic trial variables such as reaction time, trial outcome, lick counts etc.. The main ingredient in this process is the state machine that is being used in the ExperimentController in StimPy.
The parsed rawdata is aggregated in a dictioanry of dataframes and then seperated into trials by using the timings of various software and hardware signals into trials.
These trials are then collected into a dataframe, where each row is a trial.

### 2. Run ###

The aggregated trials makes up the data of the Run. Run(s) make up a Session.

### 3. Session ###

Mostly for convenience, holds one or multiple Run(s) in it.

These are mostly dependent on the behavioural/imaging data that is being analysed so a custom Trial, Run, Session classes need to be implemented to parse the data according to specific needs.

### Contribution guidelines ###

To implement a feature create a new branch *(e.g feature_VR_wheel_analysis)*

### Who do I talk to? ###

[Sakir Kaan Cetindag](sakir.kaan.cetindag@nerf.be)
